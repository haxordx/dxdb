// Set your secret key. Remember to switch to your live secret key in production!
// See your keys here: https://dashboard.stripe.com/account/apikeys
const stripe = require('stripe')('sk_test_4eC39HqLyjWDarjtT1zdp7dc');

app.post('/retrieve-subscription-information', async (req, res) => {
  const subscriptionId = req.body.subscriptionId;
  console.log(
    'subscription id is ' + subscriptionId + ' type is ' + typeof subscriptionId
  );

  const subscription = await stripe.subscriptions.retrieve(subscriptionId, {
    expand: [
      'latest_invoice',
      'customer.invoice_settings.default_payment_method',
      'plan.product',
    ],
  });

  const upcoming_invoice = await stripe.invoices.retrieveUpcoming({
    subscription: subscriptionId,
  });

  res.send({
    card: subscription.customer.invoice_settings.default_payment_method.card,
    product_description: subscription.plan.product.name,
    current_price: subscription.plan.id,
    current_quantity: subscription.items.data[0].quantity,
    latest_invoice: subscription.latest_invoice,
    upcoming_invoice: upcoming_invoice,
  });
});
// Set your secret key. Remember to switch to your live secret key in production!
// See your keys here: https://dashboard.stripe.com/account/apikeys
const stripe = require('stripe')('sk_test_4eC39HqLyjWDarjtT1zdp7dc');

app.post('/retrieve-subscription-information', async (req, res) => {
  const subscriptionId = req.body.subscriptionId;
  console.log(
    'subscription id is ' + subscriptionId + ' type is ' + typeof subscriptionId
  );

  const subscription = await stripe.subscriptions.retrieve(subscriptionId, {
    expand: [
      'latest_invoice',
      'customer.invoice_settings.default_payment_method',
      'plan.product',
    ],
  });

  const upcoming_invoice = await stripe.invoices.retrieveUpcoming({
    subscription: subscriptionId,
  });

  res.send({
    card: subscription.customer.invoice_settings.default_payment_method.card,
    product_description: subscription.plan.product.name,
    current_price: subscription.plan.id,
    current_quantity: subscription.items.data[0].quantity,
    latest_invoice: subscription.latest_invoice,
    upcoming_invoice: upcoming_invoice,
  });
});
